"use strict";(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[1760],{"../matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/SendWysiwygComposer.tsx":(e,t,n)=>{n.r(t),n.d(t,{default:()=>H});var o=n("../matrix-react-sdk/node_modules/@babel/runtime/helpers/esm/extends.js"),s=n("../matrix-react-sdk/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),r=n("./node_modules/react/index.js"),c=n("../matrix-react-sdk/src/dispatcher/dispatcher.ts"),i=n("../matrix-react-sdk/src/dispatcher/actions.ts"),a=n("../matrix-react-sdk/src/contexts/RoomContext.ts"),l=n("../matrix-react-sdk/src/hooks/useDispatcher.ts"),u=n("../matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/hooks/utils.ts"),d=n("../matrix-react-sdk/src/dispatcher/payloads/ComposerInsertPayload.ts"),m=n("../matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/ComposerContext.ts"),p=n("../matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/utils/selection.ts");var f=n("../matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/components/WysiwygComposer.tsx"),g=n("../matrix-react-sdk/node_modules/classnames/index.js"),h=n.n(g);var x=n("../matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/hooks/useIsFocused.ts");var v=n("../matrix-react-sdk/src/hooks/useSettings.ts"),C=n("../matrix-react-sdk/src/Keyboard.ts"),y=n("../matrix-js-sdk/src/logger.ts"),k=n("../matrix-react-sdk/src/Typeguards.ts");function w(e,t){var n;const[o,s]=(0,r.useState)(null),c=e=>{y.Q.log(`## 26037 ## wysiwyg useSuggestion hook setting suggestion data to ${null===e||e instanceof Function?e:e.mappedSuggestion.keyChar+e.mappedSuggestion.text}`),s(e)};return{suggestion:null!==(n=null==o?void 0:o.mappedSuggestion)&&void 0!==n?n:null,handleCommand:e=>function(e,t,n,o){var s;if(null===t)return;const{node:r}=t,c=`${e} `;r.textContent=c,null===(s=document.getSelection())||void 0===s||s.setBaseAndExtent(r,c.length,r,c.length),o(c),n(null)}(e,o,c,t),handleMention:(e,n,s)=>S(e,n,s,o,c,t),handleAtRoomMention:e=>S("#","@room",e,o,c,t),onSelect:()=>function(e,t){var n;const o=document.getSelection();if(null===e.current||null===o||!o.isCollapsed||"#text"!==(null===(n=o.anchorNode)||void 0===n?void 0:n.nodeName))return void t(null);const{anchorNode:s,anchorOffset:r}=o;if(null===s.textContent)return void t(null);const c=document.createNodeIterator(e.current,NodeFilter.SHOW_TEXT).nextNode(),i=s===c,a=function(e,t,n){if(t<0||t>e.length)return null;let o=t,s=t;for(;b(e,o);)o--;for(;T(e,s);)s++;const r=e.slice(o,s),c=function(e){const t=e.charAt(0),n=e.slice(1);switch(t){case"/":return{keyChar:t,text:n,type:"command"};case"#":case"@":return{keyChar:t,text:n,type:"mention"};default:return null}}(r);if(null===c||"command"===c.type&&(!n||0!==o||s!==e.length))return null;return{mappedSuggestion:c,startOffset:o,endOffset:o+r.length}}(s.textContent,r,i);if(null===a)return void t(null);t({mappedSuggestion:a.mappedSuggestion,node:s,startOffset:a.startOffset,endOffset:a.endOffset})}(e,c)}}function S(e,t,n,o,s,r){var c,i,a,l;if(null===o)return;const{node:u}=o,d=document.createElement("a"),m=document.createTextNode(t);d.setAttribute("href",e),d.setAttribute("contenteditable","false");for(const[e,t]of n.entries())d.setAttribute(e,t);d.appendChild(m);const p=document.createTextNode((null===(c=u.textContent)||void 0===c?void 0:c.slice(0,o.startOffset))||"â€‹"),f=document.createTextNode(` ${null!==(i=null===(a=u.textContent)||void 0===a?void 0:a.slice(o.endOffset))&&void 0!==i?i:""}`),g=u.parentNode;(0,k.g)(g)&&(g.insertBefore(p,u),g.insertBefore(d,u),g.insertBefore(f,u),g.removeChild(u)),null===(l=document.getSelection())||void 0===l||l.setBaseAndExtent(f,1,f,1),r(),s(null)}function b(e,t){return!(t<=0)&&!/\s/.test(e[t-1])}function T(e,t){return!(t>=e.length)&&!/\s/.test(e[t])}var E=n("../matrix-react-sdk/src/contexts/MatrixClientContext.tsx");function M(e,t,n,o){const s=(0,a.cF)(),c=(0,E.uw)(),i=(0,r.useRef)(null),l=(0,r.useRef)(null),[d,m]=(0,r.useState)(e),p=(0,r.useCallback)((()=>{i.current&&(i.current.innerHTML=""),null==n||n()}),[i,n]),f=(0,r.useCallback)((e=>{if((0,k.e)(e))m(e),null==t||t(e);else if((0,k.g)(i)&&(0,k.g)(i.current)){const e=i.current.innerHTML;m(e),null==t||t(e)}}),[t,i]),{suggestion:g,onSelect:h,handleCommand:x,handleMention:y,handleAtRoomMention:S}=w(i,f),b=(0,r.useCallback)((e=>{e.target instanceof HTMLDivElement&&f(e.target.innerHTML)}),[f]),T=(0,r.useCallback)((e=>{const{nativeEvent:t}=e;let n=!1;if((0,u.G)(t)){const e=t instanceof ClipboardEvent?t.clipboardData:t.dataTransfer;n=(0,u.AN)(t,e,s,c,o)}n?e.preventDefault():b(e)}),[o,c,b,s]),M=!(0,v.K)("MessageComposerInput.ctrlEnterToSend"),R=(0,r.useCallback)((e=>{if(!(0,u.iw)(l,e)&&e.key===C.as.ENTER){const t=C.M9?e.metaKey:e.ctrlKey;M&&!e.shiftKey&&(e.preventDefault(),e.stopPropagation(),p()),!M&&t&&(e.preventDefault(),e.stopPropagation(),p())}}),[l,M,p]);return{ref:i,autocompleteRef:l,onBeforeInput:T,onInput:b,onPaste:T,onKeyDown:R,content:d,setContent:f,suggestion:g,onSelect:h,handleCommand:x,handleMention:y,handleAtRoomMention:S}}var R=n("../matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/hooks/useSetCursorPosition.ts"),_=n("../matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/components/Editor.tsx"),N=n("../matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/components/WysiwygAutocomplete.tsx");function A({className:e,disabled:t=!1,onSend:n,onChange:o,children:s,placeholder:c,initialContent:i,leftComponent:a,rightComponent:l,eventRelation:u}){const{ref:d,autocompleteRef:m,onBeforeInput:f,onInput:g,onPaste:v,onKeyDown:C,content:y,setContent:k,suggestion:w,onSelect:S,handleCommand:b,handleMention:T,handleAtRoomMention:E}=M(i,o,n,u),A=function(e,t){return(0,r.useMemo)((()=>({clear:()=>{e.current&&(e.current.innerHTML="")},insertText:n=>{const o=document.getSelection();if(e.current&&o){const s=e.current.innerHTML,{anchorOffset:r,focusOffset:c}=o;e.current.innerHTML=`${s.slice(0,r)}${n}${s.slice(c)}`,(0,p.S8)({anchorNode:e.current.firstChild,anchorOffset:r+n.length,focusNode:e.current.firstChild,focusOffset:c+n.length,isForward:!0}),t(e.current.innerHTML)}}})),[e,t])}(d,k);!function(e="",t){(0,r.useEffect)((()=>{t.current&&(t.current.innerHTML=e)}),[t,e])}(i,d),(0,R.a)(t,d);const{isFocused:O,onFocus:F}=(0,x.M)(),P=!y&&c||void 0;return r.createElement("div",{className:h()(e,{[`${e}-focused`]:O}),onFocus:F,onBlur:F,onBeforeInput:f,onInput:g,onPaste:v,onKeyDown:C,onSelect:S},r.createElement(N.u,{ref:m,suggestion:w,handleMention:T,handleCommand:b,handleAtRoomMention:E}),r.createElement(_.G,{ref:d,disabled:t,leftComponent:a,rightComponent:l,placeholder:P}),null==s?void 0:s(d,A))}var O=n("../matrix-react-sdk/src/components/views/rooms/E2EIcon.tsx"),F=n("../matrix-react-sdk/src/components/views/rooms/EmojiButton.tsx");function P({menuPosition:e}){const t=(0,a.cF)();return r.createElement(F._,{menuPosition:e,addEmoji:e=>(c.cp.dispatch({action:i.S.ComposerInsert,text:e,timelineRenderingType:t.timelineRenderingType}),!0)})}const I=["isRichTextEnabled","e2eStatus","menuPosition"],B=(0,r.forwardRef)((function({disabled:e=!1,composerFunctions:t},n){return function(e,t,n){const o=(0,a.cF)(),s=(0,m.E$)(),f=(0,r.useRef)(null),g=(0,r.useCallback)((r=>{var c;if(e||null==t||!t.current)return;const l=null!==(c=r.context)&&void 0!==c?c:a.Av.Room;switch(r.action){case"reply_to_event":case i.S.FocusAComposer:case i.S.FocusSendMessageComposer:(0,u.Om)(t,l,o,f);break;case i.S.ClearAndFocusSendMessageComposer:if(r.timelineRenderingType!==o.timelineRenderingType)break;n.clear(),(0,u.Om)(t,l,o,f);break;case i.S.ComposerInsert:if(r.timelineRenderingType!==o.timelineRenderingType)break;if(r.composerType!==d.C.Send)break;r.userId||r.event||r.text&&(0,p.S8)(s.selection).then((()=>n.insertText(r.text)))}}),[e,t,o,n,s]);(0,l.S)(c.cp,g)}(e,n,t),null}));function H(e){let{isRichTextEnabled:t,e2eStatus:n,menuPosition:c}=e,i=(0,s.c)(e,I);const a=t?f.q:A,l=(0,r.useRef)((0,m.L0)({eventRelation:i.eventRelation}));return r.createElement(m.UP.Provider,{value:l.current},r.createElement(a,(0,o.c)({className:"mx_SendWysiwygComposer",leftComponent:n&&r.createElement(O.c,{status:n}),rightComponent:r.createElement(P,{menuPosition:c})},i),((e,t)=>r.createElement(B,{disabled:i.disabled,ref:e,composerFunctions:t}))))}}}]);
//# sourceMappingURL=1760.js.map