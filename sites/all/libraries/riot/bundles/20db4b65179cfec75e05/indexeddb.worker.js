(()=>{"use strict";var e,t,n={"../matrix-react-sdk/src/workers/indexeddb.worker.ts":(e,t,n)=>{var o=n("../matrix-js-sdk/node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=n("../matrix-js-sdk/node_modules/loglevel/lib/loglevel.js"),a=n.n(s);const r="matrix";function i(e){const t=e;t.getChild=t.withPrefix=function(e){return function(e){const t=a().getLogger(`${r}-${e}`);t.prefix!==e&&(i(t),t.prefix=e,t.setLevel(a().levels.DEBUG,!1));return t}((this.prefix||"")+e)}}a().methodFactory=function(e,t,n){return function(...t){this.prefix&&t.unshift(this.prefix);return"error"===e||"warn"===e||"trace"===e||"info"===e||"debug"===e?console[e](...t):console.log(...t)}};const c=a().getLogger(r);c.setLevel(a().levels.DEBUG,!1),i(c);n("../matrix-js-sdk/node_modules/unhomoglyph/index.js"),n("../matrix-js-sdk/node_modules/p-retry/index.js");class l{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){const e=[this.name],t=this.altName;return t&&e.push(t),e}matches(e){return this.name===e||this.altName===e}findIn(e){let t;return this.name&&(t=null==e?void 0:e[this.name]),!t&&this.altName&&(t=null==e?void 0:e[this.altName]),t}includedIn(e){let t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}}class d extends l{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}}var m=n("./node_modules/matrix-events-sdk/lib/index.js");new m.UnstableValue("m.message","org.matrix.msc1767.message"),new m.UnstableValue("m.text","org.matrix.msc1767.text"),new m.UnstableValue("m.html","org.matrix.msc1767.html"),new m.NamespacedValue("m.reference");new d("m.asset","org.matrix.msc3488.asset"),new d("m.ts","org.matrix.msc3488.ts"),new d("m.location","org.matrix.msc3488.location");let u=function(e){return e.Read="m.read",e.FullyRead="m.fully_read",e.ReadPrivate="m.read.private",e}({});new Map;function h(e){return JSON.parse(JSON.stringify(e))}function v(e){return Promise.resolve(e())}(()=>{let e="";for(let t=32;t<=126;t++)e+=String.fromCharCode(t)})();new Intl.Collator;function b(e){return e instanceof Map?p(e):Array.isArray(e)?e.map((e=>b(e))):e}function p(e){const t=new Map;for(const[n,o]of e)t.set(n,b(o));return Object.fromEntries(t.entries())}class g extends Map{constructor(e){super(),this.createDefault=e}getOrCreate(e){return this.has(e)||this.set(e,this.createDefault()),this.get(e)}}const y=new class extends l{constructor(...e){super(...e),(0,o.c)(this,"preferUnstable",!1)}setPreferUnstable(e){this.preferUnstable=e}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}}("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications");let f=function(e){return e.RoomCanonicalAlias="m.room.canonical_alias",e.RoomCreate="m.room.create",e.RoomJoinRules="m.room.join_rules",e.RoomMember="m.room.member",e.RoomThirdPartyInvite="m.room.third_party_invite",e.RoomPowerLevels="m.room.power_levels",e.RoomName="m.room.name",e.RoomTopic="m.room.topic",e.RoomAvatar="m.room.avatar",e.RoomPinnedEvents="m.room.pinned_events",e.RoomEncryption="m.room.encryption",e.RoomHistoryVisibility="m.room.history_visibility",e.RoomGuestAccess="m.room.guest_access",e.RoomServerAcl="m.room.server_acl",e.RoomTombstone="m.room.tombstone",e.RoomPredecessor="org.matrix.msc3946.room_predecessor",e.SpaceChild="m.space.child",e.SpaceParent="m.space.parent",e.RoomRedaction="m.room.redaction",e.RoomMessage="m.room.message",e.RoomMessageEncrypted="m.room.encrypted",e.Sticker="m.sticker",e.CallInvite="m.call.invite",e.CallCandidates="m.call.candidates",e.CallAnswer="m.call.answer",e.CallHangup="m.call.hangup",e.CallReject="m.call.reject",e.CallSelectAnswer="m.call.select_answer",e.CallNegotiate="m.call.negotiate",e.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",e.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",e.CallReplaces="m.call.replaces",e.CallAssertedIdentity="m.call.asserted_identity",e.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",e.CallEncryptionKeysPrefix="io.element.call.encryption_keys",e.KeyVerificationRequest="m.key.verification.request",e.KeyVerificationStart="m.key.verification.start",e.KeyVerificationCancel="m.key.verification.cancel",e.KeyVerificationMac="m.key.verification.mac",e.KeyVerificationDone="m.key.verification.done",e.KeyVerificationKey="m.key.verification.key",e.KeyVerificationAccept="m.key.verification.accept",e.KeyVerificationReady="m.key.verification.ready",e.RoomMessageFeedback="m.room.message.feedback",e.Reaction="m.reaction",e.PollStart="org.matrix.msc3381.poll.start",e.Typing="m.typing",e.Receipt="m.receipt",e.Presence="m.presence",e.FullyRead="m.fully_read",e.Tag="m.tag",e.SpaceOrder="org.matrix.msc3230.space_order",e.PushRules="m.push_rules",e.Direct="m.direct",e.IgnoredUserList="m.ignored_user_list",e.RoomKey="m.room_key",e.RoomKeyRequest="m.room_key_request",e.ForwardedRoomKey="m.forwarded_room_key",e.Dummy="m.dummy",e.GroupCallPrefix="org.matrix.msc3401.call",e.GroupCallMemberPrefix="org.matrix.msc3401.call.member",e.CallNotify="org.matrix.msc4075.call.notify",e}({});new d("m.room.purpose","org.matrix.msc3088.purpose"),new d("m.enabled","org.matrix.msc3088.enabled"),new d("m.data_tree","org.matrix.msc3089.data_tree"),new d("m.leaf","org.matrix.msc3089.leaf"),new d("m.branch","org.matrix.msc3089.branch"),new d("m.room.marker","org.matrix.msc2716.marker"),new d("with_rel_types","org.matrix.msc3912.with_relations"),new d("io.element.functional_members","io.element.functional_members"),new d("m.visibility","org.matrix.msc3531.visibility"),new d("enabled","org.matrix.msc3881.enabled"),new d("device_id","org.matrix.msc3881.device_id"),new d("m.local_notification_settings","org.matrix.msc3890.local_notification_settings"),new d("thread_id","org.matrix.msc4023.thread_id");class _{constructor(){(0,o.c)(this,"unthreadedReadReceipts",new Map),(0,o.c)(this,"threadedReadReceipts",new g((()=>new Map)))}setUnthreaded(e,t){this.unthreadedReadReceipts.set(e,t)}setThreaded(e,t,n){this.threadedReadReceipts.getOrCreate(e).set(t,n)}allUnthreaded(){return this.unthreadedReadReceipts.entries()}*allThreaded(){for(const e of this.threadedReadReceipts.values())for(const t of e.entries())yield t}consumeEphemeralEvents(e){null==e||e.forEach((e=>{e.type===f.Receipt&&e.content&&Object.keys(e.content).forEach((t=>{Object.entries(e.content[t]).forEach((([n,o])=>{var s;if(s=n,[u.Read,u.ReadPrivate].includes(s))for(const s of Object.keys(o)){const o=e.content[t][n][s],a={data:e.content[t][n][s],type:n,eventId:t};o.thread_id?this.setThreaded(o.thread_id,s,a):this.setUnthreaded(s,a)}}))}))}))}buildAccumulatedReceiptEvent(e){const t={type:f.Receipt,room_id:e,content:{}},n=new g((()=>new g((()=>new Map))));for(const[e,t]of this.allUnthreaded())n.getOrCreate(t.eventId).getOrCreate(t.type).set(e,t.data);for(const[e,t]of this.allThreaded())n.getOrCreate(t.eventId).getOrCreate(t.type).set(e,t.data);return t.content=p(n),n.size>0?t:null}}let k=function(e){return e.Invite="invite",e.Leave="leave",e.Join="join",e.Knock="knock",e}({});class w{constructor(e={}){this.opts=e,(0,o.c)(this,"accountData",{}),(0,o.c)(this,"inviteRooms",{}),(0,o.c)(this,"knockRooms",{}),(0,o.c)(this,"joinRooms",{}),(0,o.c)(this,"nextBatch",null),this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(e,t=!1){this.accumulateRooms(e,t),this.accumulateAccountData(e),this.nextBatch=e.next_batch}accumulateAccountData(e){e.account_data&&e.account_data.events&&e.account_data.events.forEach((e=>{this.accountData[e.type]=e}))}accumulateRooms(e,t=!1){e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach((n=>{this.accumulateRoom(n,k.Invite,e.rooms.invite[n],t)})),e.rooms.join&&Object.keys(e.rooms.join).forEach((n=>{this.accumulateRoom(n,k.Join,e.rooms.join[n],t)})),e.rooms.leave&&Object.keys(e.rooms.leave).forEach((n=>{this.accumulateRoom(n,k.Leave,e.rooms.leave[n],t)})),e.rooms.knock&&Object.keys(e.rooms.knock).forEach((n=>{this.accumulateRoom(n,k.Knock,e.rooms.knock[n],t)})))}accumulateRoom(e,t,n,o=!1){switch(t){case k.Invite:this.knockRooms[e]&&delete this.knockRooms[e],this.accumulateInviteState(e,n);break;case k.Knock:this.accumulateKnockState(e,n);break;case k.Join:this.inviteRooms[e]&&delete this.inviteRooms[e],this.accumulateJoinState(e,n,o);break;case k.Leave:this.knockRooms[e]?delete this.knockRooms[e]:this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:c.error("Unknown cateogory: ",t)}}accumulateInviteState(e,t){if(!t.invite_state||!t.invite_state.events)return;if(!this.inviteRooms[e])return void(this.inviteRooms[e]={invite_state:t.invite_state});const n=this.inviteRooms[e];t.invite_state.events.forEach((e=>{let t=!1;for(let o=0;o<n.invite_state.events.length;o++){const s=n.invite_state.events[o];s.type===e.type&&s.state_key==e.state_key&&(n.invite_state.events[o]=e,t=!0)}t||n.invite_state.events.push(e)}))}accumulateKnockState(e,t){if(!t.knock_state||!t.knock_state.events)return;if(!this.knockRooms[e])return void(this.knockRooms[e]={knock_state:t.knock_state});const n=this.knockRooms[e];t.knock_state.events.forEach((e=>{let t=!1;for(let o=0;o<n.knock_state.events.length;o++){const s=n.knock_state.events[o];s.type===e.type&&s.state_key==e.state_key&&(n.knock_state.events[o]=e,t=!0)}t||n.knock_state.events.push(e)}))}accumulateJoinState(e,t,n=!1){var o,s,a,r,i,c,l;this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_unreadThreadNotifications:{},_summary:{},_receipts:new _});const d=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach((e=>{d._accountData[e.type]=e})),t.unread_notifications&&(d._unreadNotifications=t.unread_notifications),d._unreadThreadNotifications=null!==(o=null!==(s=t[y.stable])&&void 0!==s?s:t[y.unstable])&&void 0!==o?o:void 0,t.summary){var m,u,h;const e="m.heroes",n="m.invited_member_count",o="m.joined_member_count",s=d._summary,a=t.summary;s[e]=null!==(m=a[e])&&void 0!==m?m:s[e],s[o]=null!==(u=a[o])&&void 0!==u?u:s[o],s[n]=null!==(h=a[n])&&void 0!==h?h:s[n]}if(d._receipts.consumeEphemeralEvents(null===(a=t.ephemeral)||void 0===a?void 0:a.events),t.timeline&&t.timeline.limited&&(d._timeline=[]),null===(r=t.state)||void 0===r||null===(i=r.events)||void 0===i||i.forEach((e=>{x(d._currentState,e)})),null===(c=t.timeline)||void 0===c||null===(l=c.events)||void 0===l||l.forEach(((e,o)=>{var s;let a;if(x(d._currentState,e),n)a=e;else{a=Object.assign({},e),void 0!==a.unsigned&&(a.unsigned=Object.assign({},a.unsigned));const t=e.unsigned?e.unsigned.age:e.age;void 0!==t&&(a._localTs=Date.now()-t)}d._timeline.push({event:a,token:0===o&&null!==(s=t.timeline.prev_batch)&&void 0!==s?s:null})})),d._timeline.length>this.opts.maxTimelineEntries){for(let e=d._timeline.length-this.opts.maxTimelineEntries;e<d._timeline.length;e++)if(d._timeline[e].token){d._timeline=d._timeline.slice(e,d._timeline.length);break}}}getJSON(e=!1){const t={join:{},invite:{},knock:{},leave:{}};Object.keys(this.inviteRooms).forEach((e=>{t.invite[e]=this.inviteRooms[e]})),Object.keys(this.knockRooms).forEach((e=>{t.knock[e]=this.knockRooms[e]})),Object.keys(this.joinRooms).forEach((n=>{const o=this.joinRooms[n],s={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:o._unreadNotifications,unread_thread_notifications:o._unreadThreadNotifications,summary:o._summary};Object.keys(o._accountData).forEach((e=>{s.account_data.events.push(o._accountData[e])}));const a=o._receipts.buildAccumulatedReceiptEvent(n);a&&s.ephemeral.events.push(a),o._timeline.forEach((t=>{if(!s.timeline.prev_batch){if(!t.token)return;s.timeline.prev_batch=t.token}let n;var o;!e&&("_localTs"in(o=t.event)&&void 0!==o._localTs)?(n=Object.assign({},t.event),void 0!==n.unsigned&&(n.unsigned=Object.assign({},n.unsigned)),delete n._localTs,n.unsigned=n.unsigned||{},n.unsigned.age=Date.now()-t.event._localTs):n=t.event,s.timeline.events.push(n)}));const r=Object.create(null);for(let e=s.timeline.events.length-1;e>=0;e--){const t=s.timeline.events[e];if(null===t.state_key||void 0===t.state_key)continue;const n=h(t);n.unsigned&&(n.unsigned.prev_content&&(n.content=n.unsigned.prev_content),n.unsigned.prev_sender&&(n.sender=n.unsigned.prev_sender)),x(r,n)}Object.keys(o._currentState).forEach((e=>{Object.keys(o._currentState[e]).forEach((t=>{let n=o._currentState[e][t];r[e]&&r[e][t]&&(n=r[e][t]),s.state.events.push(n)}))})),t.join[n]=s}));const n=[];return Object.keys(this.accountData).forEach((e=>{n.push(this.accountData[e])})),{nextBatch:this.nextBatch,roomsData:t,accountData:n}}getNextBatchToken(){return this.nextBatch}}function x(e,t){null!==t.state_key&&void 0!==t.state_key&&t.type&&(e[t.type]||(e[t.type]=Object.create(null)),e[t.type][t.state_key]=t)}const R=[e=>{e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]})},e=>{e.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]}).createIndex("room","room_id")},e=>{e.createObjectStore("client_options",{keyPath:["clobber"]})},e=>{e.createObjectStore("to_device_queue",{autoIncrement:!0})}],D=R.length;function S(e,t,n){const o=e.openCursor(t);return new Promise(((e,t)=>{const s=[];o.onerror=()=>{t(new Error("Query failed: "+o.error))},o.onsuccess=()=>{const t=o.result;t?(s.push(n(t)),t.continue()):e(s)}}))}function j(e){return new Promise(((t,n)=>{e.oncomplete=function(e){t(e)},e.onerror=function(){n(e.error)}}))}function O(e){return new Promise(((t,n)=>{e.onsuccess=function(e){t(e)},e.onerror=function(){n(e.error)}}))}function P(e){return O(e).then((t=>e.result))}class B{static exists(e,t){return function(e,t){return new Promise(((n,o)=>{let s=!0;const a=e.open(t);a.onupgradeneeded=()=>{s=!1},a.onblocked=()=>o(a.error),a.onsuccess=()=>{a.result.close(),s||e.deleteDatabase(t),n(s)},a.onerror=()=>o(a.error)}))}(e,t="matrix-js-sdk:"+(t||"default"))}constructor(e,t="default"){this.indexedDB=e,(0,o.c)(this,"dbName",void 0),(0,o.c)(this,"syncAccumulator",void 0),(0,o.c)(this,"db",void 0),(0,o.c)(this,"disconnected",!0),(0,o.c)(this,"_isNewlyCreated",!1),(0,o.c)(this,"syncToDatabasePromise",void 0),(0,o.c)(this,"pendingUserPresenceData",[]),this.dbName="matrix-js-sdk:"+t,this.syncAccumulator=new w}connect(e){if(!this.disconnected)return c.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,c.log("LocalIndexedDBStoreBackend.connect: connecting...");const t=this.indexedDB.open(this.dbName,D);return t.onupgradeneeded=e=>{const n=t.result,o=e.oldVersion;c.log(`LocalIndexedDBStoreBackend.connect: upgrading from ${o}`),o<1&&(this._isNewlyCreated=!0),R.forEach(((e,t)=>{o<=t&&e(n)}))},t.onblocked=()=>{c.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},c.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),O(t).then((async()=>{c.log("LocalIndexedDBStoreBackend.connect: connected"),this.db=t.result,this.db.onversionchange=()=>{var e;null===(e=this.db)||void 0===e||e.close(),this.disconnected=!0,this.db=void 0},this.db.onclose=()=>{this.disconnected=!0,this.db=void 0,null==e||e()},await this.init()}))}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then((([e,t])=>{c.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:t.nextBatch,rooms:t.roomsData,account_data:{events:e}},!0)}))}getOutOfBandMembers(e){return new Promise(((t,n)=>{const o=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),s=IDBKeyRange.only(e),a=o.openCursor(s),r=[];let i=!1;a.onsuccess=()=>{const e=a.result;if(!e)return r.length||i?t(r):t(null);const n=e.value;n.oob_written?i=!0:r.push(n),e.continue()},a.onerror=e=>{n(e)}})).then((t=>(c.log(`LL: got ${null==t?void 0:t.length} membershipEvents from storage for room ${e} ...`),t)))}async setOutOfBandMembers(e,t){c.log(`LL: backend about to store ${t.length} members for ${e}`);const n=this.db.transaction(["oob_membership_events"],"readwrite"),o=n.objectStore("oob_membership_events");t.forEach((e=>{o.put(e)}));const s={room_id:e,oob_written:!0,state_key:0};o.put(s),await j(n),c.log(`LL: backend done storing for ${e}!`)}async clearOutOfBandMembers(e){const t=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),n=IDBKeyRange.only(e),o=P(t.openKeyCursor(n,"next")).then((e=>(null==e?void 0:e.primaryKey)[1])),s=P(t.openKeyCursor(n,"prev")).then((e=>(null==e?void 0:e.primaryKey)[1])),[a,r]=await Promise.all([o,s]),i=this.db.transaction(["oob_membership_events"],"readwrite").objectStore("oob_membership_events"),l=IDBKeyRange.bound([e,a],[e,r]);var d;c.log(`LL: Deleting all users + marker in storage for room ${e}, with key range:`,[e,a],[e,r]),await(d=i.delete(l),new Promise(((e,t)=>{d.onsuccess=()=>e(d),d.onerror=e=>t(e)})))}clearDatabase(){return new Promise((e=>{var t;c.log(`Removing indexeddb instance: ${this.dbName}`),null===(t=this.db)||void 0===t||t.close();const n=this.indexedDB.deleteDatabase(this.dbName);n.onblocked=()=>{c.log(`can't yet delete indexeddb ${this.dbName} because it is open elsewhere`)},n.onerror=()=>{c.warn(`unable to delete js-sdk store indexeddb: ${n.error}`),e()},n.onsuccess=()=>{c.log(`Removed indexeddb instance: ${this.dbName}`),e()}}))}getSavedSync(e=!0){const t=this.syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(h(t)):Promise.resolve(t):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(e){return Promise.resolve().then((()=>{this.syncAccumulator.accumulate(e)}))}async syncToDatabase(e){return this.syncToDatabasePromise?(c.warn("Skipping syncToDatabase() as persist already in flight"),this.pendingUserPresenceData.push(...e),this.syncToDatabasePromise):(e.unshift(...this.pendingUserPresenceData),this.syncToDatabasePromise=this.doSyncToDatabase(e),this.syncToDatabasePromise)}async doSyncToDatabase(e){try{const t=this.syncAccumulator.getJSON(!0);await Promise.all([this.persistUserPresenceEvents(e),this.persistAccountData(t.accountData),this.persistSyncData(t.nextBatch,t.roomsData)])}finally{this.syncToDatabasePromise=void 0}}persistSyncData(e,t){return c.log("Persisting sync data up to",e),v((()=>{const n=this.db.transaction(["sync"],"readwrite");return n.objectStore("sync").put({clobber:"-",nextBatch:e,roomsData:t}),j(n).then((()=>{c.log("Persisted sync data up to",e)}))}))}persistAccountData(e){return v((()=>{const t=this.db.transaction(["accountData"],"readwrite"),n=t.objectStore("accountData");for(const t of e)n.put(t);return j(t).then()}))}persistUserPresenceEvents(e){return v((()=>{const t=this.db.transaction(["users"],"readwrite"),n=t.objectStore("users");for(const t of e)n.put({userId:t[0],event:t[1]});return j(t).then()}))}getUserPresenceEvents(){return v((()=>S(this.db.transaction(["users"],"readonly").objectStore("users"),void 0,(e=>[e.value.userId,e.value.event]))))}loadAccountData(){return c.log("LocalIndexedDBStoreBackend: loading account data..."),v((()=>S(this.db.transaction(["accountData"],"readonly").objectStore("accountData"),void 0,(e=>e.value)).then((e=>(c.log("LocalIndexedDBStoreBackend: loaded account data"),e)))))}loadSyncData(){return c.log("LocalIndexedDBStoreBackend: loading sync data..."),v((()=>S(this.db.transaction(["sync"],"readonly").objectStore("sync"),void 0,(e=>e.value)).then((e=>(c.log("LocalIndexedDBStoreBackend: loaded sync data"),e.length>1&&c.warn("loadSyncData: More than 1 sync row found."),e.length>0?e[0]:{})))))}getClientOptions(){return Promise.resolve().then((()=>S(this.db.transaction(["client_options"],"readonly").objectStore("client_options"),void 0,(e=>{var t;return null===(t=e.value)||void 0===t?void 0:t.options})).then((e=>e[0]))))}async storeClientOptions(e){const t=this.db.transaction(["client_options"],"readwrite");t.objectStore("client_options").put({clobber:"-",options:e}),await j(t)}async saveToDeviceBatches(e){const t=this.db.transaction(["to_device_queue"],"readwrite"),n=t.objectStore("to_device_queue");for(const t of e)n.add(t);await j(t)}async getOldestToDeviceBatch(){const e=this.db.transaction(["to_device_queue"],"readonly").objectStore("to_device_queue"),t=await P(e.openCursor());if(!t)return null;const n=t.value;return{id:t.key,txnId:n.txnId,eventType:n.eventType,batch:n.batch}}async removeToDeviceBatch(e){const t=this.db.transaction(["to_device_queue"],"readwrite");t.objectStore("to_device_queue").delete(e),await j(t)}async destroy(){var e;null===(e=this.db)||void 0===e||e.close()}}const C=self,E=new class{constructor(e){this.postMessage=e,(0,o.c)(this,"backend",void 0),(0,o.c)(this,"onClose",(()=>{this.postMessage.call(null,{command:"closed"})})),(0,o.c)(this,"onMessage",(e=>{var t,n,o,s,a,r,i,l,d,m,u,h,v,b,p,g;const y=e.data;let f;switch(y.command){case"setupWorker":this.backend=new B(indexedDB,y.args[0]),f=Promise.resolve();break;case"connect":f=null===(t=this.backend)||void 0===t?void 0:t.connect(this.onClose);break;case"isNewlyCreated":f=null===(n=this.backend)||void 0===n?void 0:n.isNewlyCreated();break;case"clearDatabase":f=null===(o=this.backend)||void 0===o?void 0:o.clearDatabase();break;case"getSavedSync":f=null===(s=this.backend)||void 0===s?void 0:s.getSavedSync(!1);break;case"setSyncData":f=null===(a=this.backend)||void 0===a?void 0:a.setSyncData(y.args[0]);break;case"syncToDatabase":f=null===(r=this.backend)||void 0===r?void 0:r.syncToDatabase(y.args[0]);break;case"getUserPresenceEvents":f=null===(i=this.backend)||void 0===i?void 0:i.getUserPresenceEvents();break;case"getNextBatchToken":f=null===(l=this.backend)||void 0===l?void 0:l.getNextBatchToken();break;case"getOutOfBandMembers":f=null===(d=this.backend)||void 0===d?void 0:d.getOutOfBandMembers(y.args[0]);break;case"clearOutOfBandMembers":f=null===(m=this.backend)||void 0===m?void 0:m.clearOutOfBandMembers(y.args[0]);break;case"setOutOfBandMembers":f=null===(u=this.backend)||void 0===u?void 0:u.setOutOfBandMembers(y.args[0],y.args[1]);break;case"getClientOptions":f=null===(h=this.backend)||void 0===h?void 0:h.getClientOptions();break;case"storeClientOptions":f=null===(v=this.backend)||void 0===v?void 0:v.storeClientOptions(y.args[0]);break;case"saveToDeviceBatches":f=null===(b=this.backend)||void 0===b?void 0:b.saveToDeviceBatches(y.args[0]);break;case"getOldestToDeviceBatch":f=null===(p=this.backend)||void 0===p?void 0:p.getOldestToDeviceBatch();break;case"removeToDeviceBatch":f=null===(g=this.backend)||void 0===g?void 0:g.removeToDeviceBatch(y.args[0])}void 0!==f?f.then((e=>{this.postMessage.call(null,{command:"cmd_success",seq:y.seq,result:e})}),(e=>{c.error("Error running command: "+y.command,e),this.postMessage.call(null,{command:"cmd_fail",seq:y.seq,error:{message:e.message,name:e.name}})})):this.postMessage({command:"cmd_fail",seq:y.seq,error:"Unrecognised command"})}))}}(C.postMessage);C.onmessage=E.onMessage}},o={};function s(e){var t=o[e];if(void 0!==t)return t.exports;var a=o[e]={exports:{}};return n[e].call(a.exports,a,a.exports,s),a.exports}s.m=n,s.x=()=>{var e=s.O(void 0,[5976,4592],(()=>s("../matrix-react-sdk/src/workers/indexeddb.worker.ts")));return e=s.O(e)},e=[],s.O=(t,n,o,a)=>{if(!n){var r=1/0;for(d=0;d<e.length;d++){for(var[n,o,a]=e[d],i=!0,c=0;c<n.length;c++)(!1&a||r>=a)&&Object.keys(s.O).every((e=>s.O[e](n[c])))?n.splice(c--,1):(i=!1,a<r&&(r=a));if(i){e.splice(d--,1);var l=o();void 0!==l&&(t=l)}}return t}a=a||0;for(var d=e.length;d>0&&e[d-1][2]>a;d--)e[d]=e[d-1];e[d]=[n,o,a]},s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var n in t)s.o(t,n)&&!s.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},s.f={},s.e=e=>Promise.all(Object.keys(s.f).reduce(((t,n)=>(s.f[n](e,t),t)),[])),s.u=e=>"bundles/"+s.h()+"/"+(5976===e?"unhomoglyph_data":e)+".js",s.miniCssF=e=>{},s.h=()=>"20db4b65179cfec75e05",s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e;s.g.importScripts&&(e=s.g.location+"");var t=s.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");if(n.length)for(var o=n.length-1;o>-1&&!e;)e=n[o--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),s.p=e+"../../"})(),(()=>{var e={5152:1};s.f.i=(t,n)=>{e[t]||importScripts(s.p+s.u(t))};var t=self.webpackChunkelement_web=self.webpackChunkelement_web||[],n=t.push.bind(t);t.push=t=>{var[o,a,r]=t;for(var i in a)s.o(a,i)&&(s.m[i]=a[i]);for(r&&r(s);o.length;)e[o.pop()]=1;n(t)}})(),t=s.x,s.x=()=>Promise.all([s.e(5976),s.e(4592)]).then(t);s.x()})();
//# sourceMappingURL=indexeddb.worker.js.map